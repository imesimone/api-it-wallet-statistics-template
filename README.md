# IT-Wallet Statistics API Template

Standard OpenAPI template for monitoring and statistics services within the IT-Wallet ecosystem.

## üìå Overview
This repository provides a `template.yaml` OpenAPI specification designed for **Regional Hubs** and **Technical Aggregators**. It establishes a standard interface to expose aggregated authentication data for multiple federated entities managed by a single access point.

## üöÄ Getting Started

### Placeholder Replacement
Before deployment, replace the following placeholder values in `template.yaml` with your entity's specific details:

| Placeholder | Context | Description |
| :--- | :--- | :--- |
| `regione.toscana.it` | Info / URLs | Official domain of the aggregator. |
| `note-legali` | Terms of Service | URL path for legal documentation. |
| `CREDENTIAL_SERVICE_NAME` | Contact | Name of the specific service (e.g., `Patente di Guida`). |
| `ISSUING_ENTITY` | Contact | Issuing organization (e.g., `Ministero delle Infrastrutture`). |
| `technical.support@...` | Email | Technical support contact. |
| `00000000-0000-...` | x-api-id | PDND API ID (UUID). |
| `api.production...` | Servers | Production environment endpoint. |
| `r_toscan` | Examples | Example IPA code (Tuscany Region used as default). |

## üõ† API Design Principles

### 1. Flexible Query Interface
To handle complex filtering without URL length limitations, statistics are retrieved via `POST` methods:
- `/auth-stats/summary`: Global aggregated report for the requested period.
- `/auth-stats/breakdown`: Detailed, paginated list of metrics.

### 2. Time Range & Granularity
- **Inclusive Dates**: Filters use `from` and `to` (ISO 8601), both inclusive.
- **Dynamic Granularity**: Support for `daily`, `monthly` (default), `yearly`, and `total` views.
- **Reporting Period**: The response includes the actual period covered by the data, ensuring transparency if data is unavailable for certain ranges (e.g., future dates or before service launch).

### 3. Failure Categorization
Failures are categorized to facilitate troubleshooting:
- **Technical**: Infrastructure, server-side, or connectivity issues (Aggregator responsibility).
- **Business**: Token expiration, unauthorized access, or logic-level issues (User/Client responsibility).

### 4. Pagination of Time Buckets
In the `/auth-stats/breakdown` endpoint, `limit` and `offset` do not paginate raw authentication logs, but the **time-based entries (buckets)** generated by the query.
- **Example**: If a `daily` granularity is requested for a full year (365 days), the API will generate 365 breakdown entries.
- **Usage**: A client can use `limit: 30` and `offset: 0` to retrieve the first month of daily data, then `offset: 30` for the next, and so on.
- **Total Items**: The `pagination.totalItems` field represents the total number of buckets within the requested `period`.

## üìä Breakdown Examples

The `/auth-stats/breakdown` response adapts its labels and granularity based on the requested parameters.

### Case 1: Daily Analysis for a Specific Entity
**Goal**: Monitor the performance of a specific municipality (IPA: `c_h501`) over a weekend.

**Request (`POST /auth-stats/breakdown`)**:
```json
{
  "period": { "from": "2025-03-01", "to": "2025-03-02" },
  "granularity": "daily",
  "ipaCode": "c_h501"
}
```

**Response**:
```json
{
  "period": { "from": "2025-03-01", "to": "2025-03-02" },
  "pagination": { "limit": 10, "offset": 0, "totalItems": 2 },
  "breakdown": [
    {
      "label": "2025-03-01",
      "granularity": "daily",
      "stats": {
        "total": 150,
        "success": 142,
        "failure": { "total": 8, "technical": 1, "business": 7 }
      }
    },
    {
      "label": "2025-03-02",
      "granularity": "daily",
      "stats": {
        "total": 120,
        "success": 118,
        "failure": { "total": 2, "technical": 0, "business": 2 }
      }
    }
  ]
}
```

### Case 2: Regional Monthly Trends (Aggregated)
**Goal**: Retrieve monthly statistics for all managed administrations during the first quarter. Note that `ipaCode` is omitted to get the total regional view.

**Request (`POST /auth-stats/breakdown`)**:
```json
{
  "period": { "from": "2025-01-01", "to": "2025-03-31" },
  "granularity": "monthly",
  "limit": 3
}
```

**Response**:
```json
{
  "period": { "from": "2025-01-01", "to": "2025-03-31" },
  "pagination": { "limit": 3, "offset": 0, "totalItems": 3 },
  "breakdown": [
    {
      "label": "2025-01",
      "granularity": "monthly",
      "stats": {
        "total": 45000,
        "success": 44200,
        "failure": { "total": 800, "technical": 150, "business": 650 }
      }
    },
    {
      "label": "2025-02",
      "granularity": "monthly",
      "stats": {
        "total": 42000,
        "success": 41500,
        "failure": { "total": 500, "technical": 50, "business": 450 }
      }
    },
    {
      "label": "2025-03",
      "granularity": "monthly",
      "stats": {
        "total": 48000,
        "success": 47300,
        "failure": { "total": 700, "technical": 100, "business": 600 }
      }
    }
  ]
}
```

### Case 3: Multi-Year Comparison
**Goal**: Compare annual performance for a specific administration.

**Request (`POST /auth-stats/breakdown`)**:
```json
{
  "period": { "from": "2023-01-01", "to": "2024-12-31" },
  "granularity": "yearly",
  "ipaCode": "r_toscan"
}
```

**Response**:
```json
{
  "period": { "from": "2023-01-01", "to": "2024-12-31" },
  "pagination": { "limit": 10, "offset": 0, "totalItems": 2 },
  "breakdown": [
    {
      "label": "2023",
      "granularity": "yearly",
      "stats": {
        "total": 500000,
        "success": 490000,
        "failure": { "total": 10000, "technical": 2000, "business": 8000 }
      }
    },
    {
      "label": "2024",
      "granularity": "yearly",
      "stats": {
        "total": 650000,
        "success": 642000,
        "failure": { "total": 8000, "technical": 1000, "business": 7000 }
      }
    }
  ]
}
```

## üîí Compliance & Headers

To ensure interoperability and security, the following standards are implemented:

- **Cache-Control**: Strict policy (`no-store`, `no-cache`, `private`, `max-age=0`) to prevent stale data usage or leaks.
- **Rate-Limiting**: Uses `X-RateLimit-*` headers to communicate quotas.
- **Retry-After**: Provided in `429` (Too Many Requests) and `503` (Service Unavailable) responses. When present, `X-RateLimit` headers are omitted to avoid ambiguity and compliance with RFCs.
- **Problem Details**: Error responses follow **RFC 7807** (`application/problem+json`).

## ‚öñÔ∏è License
This project is licensed under the **European Union Public Licence (EUPL-1.2)**. See the `LICENSE` file for details.
